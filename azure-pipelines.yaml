name: Azure Pipelines
variables:
  python.version: '3.7.6'
stages:
- stage: Build
  jobs:
  - job: Build
    pool:
      name: Hosted Ubuntu 1604
    steps:
      # Needed for Terraform VM deployment
    - task: InstallSSHKey@0
      displayName: 'Install an SSH key'
      inputs:
        #knownHostsEntry: '$(Parameters.hostName)'
        knownHostsEntry: '40.117.183.73 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDhFSfJLaafvuT2U1WfkkAmJ4sHJSOrj4LO2oEF9bd+R6ttPau1r8k7qN2x8lcWe+30BK2n6qmVhWgfdXfj3Ce1J1lrdWiN2O8iZI8qXlb8/YtrJzpI8f8vdTFkH5XtS8h5wuGTr4s+Pl2tcYwHMZYSA1XYnGxhGZ+5n+BhAkGTnLolMS+1gYSkf7fIdrv0SY/BJQFpvY6N7jRGvU7jyH8rJq2sRLD5ovM9Jg7Vz+x2lEouMLnNhAIwduFlATaBgnR3CsbiqauqVIuM1Ls863k+K2Rnh75dQjkiDegwWNjEDhL459FFgLbJvWMlFHZ1qOaxh98VRcL1NhIxbdoTdDX/'
        sshPublicKey: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDIIPTaZt4Ml1Q3QKhy1c4/FAkzrsDOqkTxr+SUznl5R9iPz0epVSStSgLQAaMJpJqBl1vsx1E90f8KLsUvy0wtU9nCK7xep0Pitd9H2LhQ+6T20hQ9ZwbeciK8x9JUcpojVd1TVu5w23WSV2o2MXlGhCwcBQ6XcOX8vZyi2DZxo2JS5GPtVy15rqfrVHKsVf3uPOCGMN7uS12AywMx1KIPVw1n8O1koXmurs9YMD2w4QM1ePka7voCLtEEgwmAEmRc+46VQggm8zVXij0qmkvAv6X3Wx6ZrCxGLNehZzolFyHc5qD8w8nthMva3wA7t7zyZ3Ov604QTN/wgpAdOTi+QL7ShN+yUPVWX6xj6AxcfGLcyrCnNB04UGvWwtM9AhjFaV9Wn2f1HdsT8hGfxQxB2kJ9Ce86shKNdNAaMz1lKvdIJSY+dUYq+q67ECaXpSBepRgS3EZnRkgkTQ81R+vbJJfQLCRZ/oHlu38CEakKhDOey+ykypA7QZjRJwRGd1KHbWFZnIUpz8Nh5fNvK6801WynoQliuoACmK/Hzce5hvpcxoHCxXHO4V4vikMWUdjWIBjaOKC9FIdOssjVZvrZ8MfJ0bN7K3Wb9W0EGi+fcsRrbkY3lA5uSgOee2Yy4A4Hid/q3cK61rxXks4KNGoRbLxTJ/nc/F/eOMnNh0hJnw== ivan-clare_ngong@cc-5e527817-57867fbbf6-w9frb'
        sshKeySecureFile: 'id_rsa'
    - task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0
      displayName: 'Use Terraform latest'
      inputs:
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
    - task: TerraformTaskV1@0
      displayName: 'terraform init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
        backendServiceArm: 'quality'
        backendAzureRmResourceGroupName: 'azuredevops'
        backendAzureRmStorageAccountName: 'tstate14906'
        backendAzureRmKey: 'terraform.tfstate'
        backendAzureRmContainerName: tstate
    - task: TerraformCLI@0
      displayName: 'terraform validate'
      inputs:
        command: 'validate'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
    - task: TerraformCLI@0
      displayName: 'terraform apply'
      inputs:
        command: 'apply'
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
    - task: ArchiveFiles@2
      displayName: 'Archive Autmated Tests'
      inputs:
        rootFolderOrFile: 'automatedtesting'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-automatedtests.zip'
    - task: ArchiveFiles@2
      displayName: 'Archive FakeRestAPI'
      inputs:
        rootFolderOrFile: 'automatedtesting/jmeter/fakerestapi'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip'
    
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip
      displayName: 'Upload Package'
      artifact: drop-fakerestapi
    
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-automatedtests.zip
      displayName: 'Upload Automatedtests'
      artifact: drop-automatedtests

      # Running Postman
    - task: CmdLine@2
      displayName: 'Running Postman Test'
      inputs:
        script: |
          npm install -g newman
          newman run StarterAPIs.json -e StarterAPIEnvironment.postman_environment.json  --reporters cli,junit --reporter-junit-export junitReport.xml
          #newman run StarterAPIs.json --reporters cli,junit --reporter-junit-export junitReport.xml
        workingDirectory: $(System.DefaultWorkingDirectory)/automatedtesting/postman
    - task: Bash@3
      displayName: 'Searching for Report'
      inputs:
        targetType: 'inline'
        script: |
          #! /bin/bash
          pwd
          echo "$(System.DefaultWorkingDirectory)"
          locate junitReport.xml
          ls -lrthaR
          #cat $(System.DefaultWorkingDirectory)/automatedtesting/postman/junitReport.xml           
          cat $(System.DefaultWorkingDirectory)/automatedtesting/postman/junitReport.xml      
    - task: PublishTestResults@2
      displayName: 'Publish Postman Test Result'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'junitReport.xml'
        searchFolder: $(System.DefaultWorkingDirectory)/automatedtesting/postman/
        testRunTitle: 'Postman Results'
    - task: CopyFilesOverSSH@0
      displayName: 'Copy files to VM'
      inputs:
        sshEndpoint: sshquality
        contents: '*/*/*py*'
        readyTimeout: '20000'
        overwrite: true
        flattenFolders: false
        sourceFolder: ''

# Deployment Stage
- stage:
  jobs:
  - deployment: FakeRestAPI
    pool:
      vmImage: 'Ubuntu-16.04'
    environment: 'DeploymentEnv'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: 'Deploy Azure Web App'
            inputs:
              azureSubscription: 'quality'
              appName: 'quality-app'
              appType: webAppLinux
              deploymentMethod: zipDeploy
              package: $(Pipeline.Workspace)/drop-fakerestapi/$(Build.BuildId)-fakerestapi.zip

  - deployment: VMDeploy
    displayName: Configure VM
    environment:
      name:  ProductionEnv
      resourceType: VirtualMachine
      tags: myVM
    strategy:
      runOnce:
        deploy:
          steps:
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                #! /bin/bash
               
                sudo apt-get upgrade -y
                sudo apt-get install python3-pip -y
                sudo apt-get install unzip -y
                sudo apt-get install -y chromium-browser
                pip3 install selenium
                export PATH=$PATH:some/path
                echo "Output of PATH"
                echo $PATH
                echo "Hello World this works"
                sudo rm -rf chromedriver*
                wget "https://chromedriver.storage.googleapis.com/83.0.4103.39/chromedriver_linux64.zip"
          
          - task: ExtractFiles@1
            displayName: 'Extract files'
            inputs:
              archiveFilePatterns:  '*chromedriver_linux64.zip'
              destinationFolder: ''
              cleanDestinationFolder: false
              
          - task: Bash@3
            displayName: 'Complete Setup of Chromedriver in VM'
            inputs:
              targetType: 'inline'
              script: |
                #! /bin/bash
    
                pwd
                sudo cp chromedriver /usr/bin
                echo "Done Settingup"  

        #Running Selenium Test
          - task: Bash@3
            displayName: 'Running Selenium Test'
            inputs:
              targetType: 'inline'
              script: |
                #! /bin/bash
                pwd
                echo "Hello World this works"
                cd /home/benoit/automatedtesting/selenium/
                #wget https://chromedriver.storage.googleapis.com/81.0.4044.138/chromedriver_linux64.zip
                #unzip chromedriver_linux64.zip
                #cat /home/casita/automatedtesting/selenium/login.py
                python3 /home/benoit/automatedtesting/selenium/login.py
 
  # Running Jmeter Tests
  - job: Jmeter
    pool:
      vmImage: 'ubuntu-latest'
    steps:
#    - task: JavaToolInstaller@0
#      displayName: 'Install Java 8'
#      inputs:
#        versionSpec: '8'
#        jdkArchitectureOption: 'x64'
#        jdkSourceOption: 'PreInstalled'
    - task: AlexandreGattiker.jmeter-tasks.custom-jmeter-installer-task.JMeterInstaller@0
      displayName: 'Install JMeter 5.2.1'
    - task: Bash@3
      displayName: 'Run Jmeter test'
      inputs:
        targetType: 'inline'
        script: |
          locate jmeter
          jmeter -n -t automatedtesting/jmeter/activities.jmx -Jresdir=automatedtesting/jmeter/pages.csv